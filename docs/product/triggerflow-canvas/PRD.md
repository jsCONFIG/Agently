# Triggerflow Canvas 产品需求文档（PRD）

## 产品目标
- 帮助自动化工程师和业务运营人员通过可视化画布快速编排、调试和发布事件驱动的工作流。
- 降低触发器、条件、动作等自动化元素的配置门槛，实现跨系统的数据流转与自动化执行。
- 提供统一的监控与告警能力，提升工作流运行的可观测性和可靠性。

## 用户画像
1. **自动化工程师（Automation Engineer）**
   - 负责企业内部系统集成与自动化建设。
   - 熟悉 API、Webhook、消息队列等技术，有脚本开发经验。
   - 目标：快速构建和维护复杂工作流，保证可靠性与可观测性。
2. **业务运营人员（Ops/Marketing Ops）**
   - 需要在营销、运营、客服场景中配置自动化流程。
   - 熟悉业务流程但技术背景有限，依赖图形化工具完成配置。
   - 目标：在无代码/低代码环境下自主完成流程搭建和迭代。
3. **合作伙伴/ISV 开发者**
   - 为客户交付定制化自动化解决方案。
   - 需要可扩展的组件市场、可重用模板，以及易于交付的协作能力。

## 核心需求
- **可视化流程设计**：提供画布式拖拽体验，支持节点（触发器、条件、动作）连接与配置。
- **事件触发管理**：内置常见触发源（Webhook、定时器、消息总线），支持自定义触发器和认证管理。
- **执行路径与条件控制**：提供条件分支、并行、循环等控制节点，并可配置超时、重试策略。
- **数据映射与转换**：内置数据映射器，支持字段映射、格式转换、自定义脚本执行。
- **版本管理与发布**：支持工作流版本控制、灰度发布、回滚与审计日志。
- **运行监控与告警**：提供节点级运行日志、性能指标、失败告警和重放功能。
- **协作与模板**：支持多人协作编辑、模板市场与共享机制，便于快速复制成熟流程。

## 功能详细设计

### 1. 画布编辑器与画布服务
- **画布布局**：采用无限画布，默认 200% 缩放，支持鼠标滚轮缩放、空格拖动画布；节点之间提供吸附对齐线。
- **节点管理**：左侧节点面板按「触发器 / 条件 / 动作 / 控制」分组，支持拖入、复制、删除、批量选中；每个节点生成唯一 UUID，并在画布服务中维护节点树结构。
- **连线逻辑**：仅允许从上游节点的「输出锚点」拖拽到下游节点的「输入锚点」，支持多出口（条件分支）和多入口（汇聚）。非法连线在松手时提示原因。
- **状态管理**：使用前端状态容器（如 Zustand）维护画布快照，支持撤销/重做（最近 20 步），并在保存时序列化为 JSON DSL。
- **草稿自动保存**：编辑器每 30 秒触发一次自动保存，将当前 DSL 上传至 `/api/workflows/{id}/draft`，失败时在页面顶部提示并支持手动重试。

### 2. 节点配置面板
- **触发器节点**：配置项包括触发类型（Webhook / 定时 / 消息）、认证方式、入站字段映射；Webhook 支持自动生成签名密钥与示例 cURL。
- **条件节点**：提供可视化条件构建器（字段 + 运算符 + 值），支持 AND/OR 嵌套；展示实时校验结果并提示数据类型不匹配。
- **动作节点**：根据动作模板动态渲染表单，字段支持引用上游节点输出（使用 `{{nodeId.field}}` 表达式），并在右侧显示测试运行面板。
- **通用功能**：每个节点支持版本备注、启用/禁用开关、错误处理策略（重试次数、间隔、失败路径）。配置变更后自动更新画布状态。

### 3. 数据映射与转换
- **字段选择器**：内嵌树形数据浏览器，展示触发器与上游节点输出字段，支持拖入目标字段形成映射。
- **表达式编辑器**：内置轻量表达式语言，支持基础算术、字符串拼接、条件运算及内置函数（`formatDate`、`toNumber` 等），提供实时校验和执行预览。
- **数据样本**：从最新 5 次执行中自动获取样本数据，用户可选择样本进行映射调试；若无样本则提示上传 JSON 示例。
- **错误处理**：表达式执行失败时可选择「使用默认值」、「终止流程」或「进入失败分支」。

### 4. 工作流执行引擎
- **执行模型**：采用事件驱动异步引擎，触发器将事件写入队列，由执行器拉取并按拓扑排序执行节点，支持并行分支的并发调度。
- **运行态存储**：在 Redis 中记录运行实例（runId）状态、上下文变量和节点执行结果，便于监控页面实时读取。
- **重试策略**：全局默认重试 3 次（指数退避 30s 起），节点可自定义覆盖；重试失败触发告警并保留上下文供手动重放。
- **超时控制**：节点层定义超时时间，超过后自动标记失败并进入失败路径；支持自定义补偿动作。

### 5. 版本管理与发布流
- **版本快照**：每次发布前将画布 DSL 与节点配置打包存入版本仓库（PostgreSQL `workflow_versions` 表），包含发布人、时间、备注。
- **差异对比**：发布弹窗中展示当前草稿与上一个已发布版本的差异（新增/修改/删除节点、配置变更摘要）。
- **灰度发布**：支持按环境（Sandbox/Production）或按触发器来源账号灰度；灰度期内可实时查看命中情况并支持一键回滚。
- **回滚流程**：选择目标版本后恢复 DSL 并生成新草稿，发布成功后自动更新运行中的实例引用。

### 6. 运行监控与告警
- **仪表板指标**：展示成功率、平均耗时、执行次数、失败分布，可按时间区间与标签过滤。
- **执行轨迹**：点击某次运行进入时序图界面，按节点顺序展示状态、耗时、输入输出数据摘要，支持下载详细日志。
- **告警通道**：可配置 Email、Slack、Webhook 等告警渠道，支持阈值（失败率、超时次数）与静默期设置。
- **重放功能**：运行详情页提供「重放」按钮，可选择使用原始输入或修改后的输入重新执行流程，并记录重放人及备注。

### 7. 模板中心与协作
- **模板目录**：模板按行业、场景、系统集成分组，支持关键词搜索与标签筛选；每个模板包含描述、预估配置时间、所需权限。
- **一键导入**：导入时提示所需连接器与凭证状态，缺失时跳转至凭证配置页面；导入完成后在画布中高亮需二次确认的节点。
- **协作能力**：支持在线协作指针、评论与 @ 成员；评论与画布元素绑定，状态分为「待处理 / 已解决」。
- **权限控制**：MVP 提供管理员、编辑、访客三种角色，编辑权限支持“只读画布 / 可发布”两级开关，所有变更记录写入活动日志。

### 8. 接入与扩展
- **连接器管理**：提供统一凭证库，支持 OAuth2、API Key、Basic Auth 等方式；凭证加密存储于 KMS，调用时临时解密。
- **自定义节点 SDK**：通过 Node.js SDK 定义输入输出模式、配置表单 Schema 及执行逻辑，审批通过后可在节点面板中启用。
- **审计与合规**：记录关键操作（创建/发布/删除工作流、修改凭证）的审计日志，支持导出 CSV 并对接企业 SIEM。
- **性能与安全**：执行引擎采用隔离工作池，节点执行在容器中沙箱运行；对外 Webhook 支持 IP 白名单与请求签名验证。

## MVP 范围
- 画布式流程搭建：触发器、条件、动作三类基础节点的拖拽连接与配置界面。
- Webhook 和定时器两类触发器，内置常见 SaaS 动作（Slack、Email、Webhook 调用）。
- 条件分支和并行执行两种控制流，支持基础的数据映射（字段映射、简单表达式）。
- 基础版本管理：草稿、已发布两个状态；简单的发布/回滚。
- 运行监控面板：实时运行日志、失败重试、手动重放。
- 单人编辑与流程模板的导入导出（JSON）。

## 非目标
- 不支持复杂的机器学习/AI 推理节点集成（后续版本考虑）。
- 不提供完全自定义 UI 的前端建模器，仅限于内置节点配置表单。
- 不涵盖企业级权限矩阵与组织架构管理，仅提供基础角色（管理员/编辑/访客）。
- 不支持离线部署与私有云安装，聚焦 SaaS 交付模式。

## 里程碑与验收标准
### MVP
- **核心能力上线**：用户可在画布中创建包含触发器、条件和动作的工作流并成功发布。
- **运行可靠性**：工作流可被触发，日志可查看，失败可重试。
- **基础监控**：仪表板显示执行历史与关键指标（成功率、平均耗时）。
- **验收标准**：完成 5 个真实业务场景的端到端验证，90%+ 的成功执行率，用户反馈表满意度 ≥ 4/5。

### Beta
- **高级触发器与动作扩展**：支持消息队列、CRM、工单系统等常用集成。
- **协作能力**：多人协作、评论、变更记录上线。
- **可扩展模板市场**：支持模板分类、搜索及权限控制。
- **验收标准**：完成 3 家外部试点客户的上线，流程创建时间较人工方案缩短 60%，客户 NPS ≥ 20。

### GA（General Availability）
- **企业级能力**：引入多环境管理、审计合规、SLA 监控与备份恢复。
- **生态开放**：开放插件/节点 SDK，支持第三方开发者入驻。
- **运营能力**：完善的计费、配额、使用分析报表。
- **验收标准**：通过安全与合规评审，稳定运行 3 个月以上，月活跃工作流数量 ≥ 500，付费续订率 ≥ 95%。
